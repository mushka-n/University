# Лабораторная работа по курсу БД

Автор **[@Никита Мушка](https://github.com/mushka-n)**, **[@Станислав Стоянов](https://github.com/ssstoyanov)**

## Вариант 1

### Уровень 1

---

1. Дана схема базы данных в виде следующих отношений. С помощью операторов SQL создать логическую структуру
   соответствующих таблиц для хранения в СУБД, используя известные средства поддержания целостности (NOT NULL, UNIQUE, и
   т.д.). Обосновать выбор типов данных и используемые средства поддержания целостности. При выборе подходящих типов
   данных использовать информацию о конкретных значениях полей БД

Покупатель

|ИДЕНТИФИКАТОР|ФАМИЛИЯ|РАЙОН ПРОЖИВАНИЯ|СКИДКА, %|
|:----:|:----:|:----:|:----:|

Магазин

|ИДЕНТИФИКАТОР|НАЗВАНИЕ|РАЙОН РАЗМЕЩЕНИЯ|КОММИСИОННЫЕ, %|
|:----:|:----:|:----:|:----:|

Книги

|ИДЕНТИФИКАТОР|НАЗВАНИЕ|СТОИМОСТЬ, РУБ.|СКЛАД|КОЛ-ВО|
|:----:|:----:|:----:|:----:|:----:|

Покупка

|НОМЕР ЗАКАЗА|ДАТА|ПРОДАВЕЦ|ПОКУПАТЕЛЬ|КНИГА|КОЛ-ВО|СУММА, РУБ|
|:----:|:----:|:----:|:----:|:----:|:----:|:----:|

```sql
create table ПОКУПАТЕЛЬ
(
    ИДЕНТИФИКАТОР      serial                                                   not null primary key,
    ФАМИЛИЯ            varchar(31)                                              not null,
    "РАЙОН ПРОЖИВАНИЯ" varchar(255)                                             not null,
    "СКИДКА, %"        smallint check ("СКИДКА, %" >= 0 AND "СКИДКА, %" <= 100) not null
);

create table МАГАЗИН
(
    ИДЕНТИФИКАТОР      serial                                                               not null primary key,
    НАЗВАНИЕ           varchar(31)                                                          not null,
    "РАЙОН РАЗМЕЩЕНИЯ" varchar(255)                                                         not null,
    "КОММИСИОННЫЕ, %"  smallint check ("КОММИСИОННЫЕ, %" >= 0 AND "КОММИСИОННЫЕ, %" <= 100) not null
);

create table КНИГИ
(
    ИДЕНТИФИКАТОР     serial                                not null primary key,
    НАЗВАНИЕ          varchar(255)                          not null,
    "СТОИМОСТЬ, РУБ." integer check ("СТОИМОСТЬ, РУБ." > 0) not null,
    СКЛАД             varchar(255)                          not null,
    "КОЛ-ВО"          integer check ("КОЛ-ВО" > 0)          not null
);


create table ПОКУПКА
(
    "НОМЕР ЗАКАЗА" serial                           not null primary key,
    ДАТА           varchar(10)                      not null,
    ПРОДАВЕЦ       serial                           not null references МАГАЗИН (ИДЕНТИФИКАТОР),
    ПОКУПАТЕЛЬ     serial                           not null references ПОКУПАТЕЛЬ (ИДЕНТИФИКАТОР),
    КНИГА          serial                           not null references КНИГИ (ИДЕНТИФИКАТОР),
    "КОЛ-ВО"       smallint check ("КОЛ-ВО" > 0)    not null,
    "СУММА, РУБ"   integer check ("СУММА, РУБ" > 0) not null
);
```

---

2. Ввести в ранее созданные таблицы конкретные данные. Использовать скрипт-файл из операторов INSERT или вспомогательную
   утилиту

```sql
insert into "ПОКУПАТЕЛЬ" ("ИДЕНТИФИКАТОР", "ФАМИЛИЯ", "РАЙОН ПРОЖИВАНИЯ", "СКИДКА, %")
values (001, 'Cидоров', 'Нижегородский', 10),
       (002, 'Потапов', 'Советский', 20),
       (003, 'Попов', 'Ленинский', 10),
       (004, 'Романова', 'Нижегородский', 10),
       (005, 'Миронов', 'Автозаводский', 15),
       (006, 'Попов', 'Советский', 0);

insert into "МАГАЗИН" ("ИДЕНТИФИКАТОР", "НАЗВАНИЕ", "РАЙОН РАЗМЕЩЕНИЯ", "КОММИСИОННЫЕ, %")
values (001, 'Знание', 'Автозаводский', 7),
       (002, 'Наука', 'Нижегородский', 8),
       (003, 'Книжный мир', 'Приокский', 6),
       (004, 'Книги', 'Сормовский', 9),
       (005, 'Книги', 'Советский', 7);

insert into "КНИГИ" ("ИДЕНТИФИКАТОР", "НАЗВАНИЕ", "СТОИМОСТЬ, РУБ.", "СКЛАД", "КОЛ-ВО")
values (001, 'Windows для чайников', 15000, 'Сормовский', 400),
       (002, 'Excel 5.0', 23000, 'Сормовский', 360),
       (003, 'Работа с Visual FoxPro', 32000, 'Нижегородский', 300),
       (004, 'Программирование в среде Delphi', 20000, 'Нижегородский', 100),
       (005, 'SQL', 47000, 'Автозаводский', 89),
       (006, 'Word 6.0 для Windows', 16000, 'Сормовский', 200),
       (007, 'Твой первый выход в Internet', 15000, 'Советский', 140);

insert into "ПОКУПКА" ("НОМЕР ЗАКАЗА", "ДАТА", "ПРОДАВЕЦ", "ПОКУПАТЕЛЬ", "КНИГА", "КОЛ-ВО", "СУММА, РУБ")
values (10011, 'Январь', 001, 006, 003, 2, 64000),
       (10012, 'Январь', 001, 006, 002, 2, 46000),
       (10013, 'Январь', 005, 005, 004, 4, 80000),
       (10014, 'Февраль', 001, 003, 003, 3, 96000),
       (10015, 'Февраль', 004, 006, 002, 1, 23000),
       (10016, 'Март', 001, 004, 007, 2, 30000),
       (10017, 'Март', 005, 006, 006, 3, 48000),
       (10018, 'Апрель', 001, 001, 003, 3, 96000),
       (10019, 'Апрель', 003, 003, 007, 2, 30000),
       (10020, 'Апрель', 005, 002, 002, 5, 115000),
       (10021, 'Апрель', 005, 002, 001, 3, 45000),
       (10022, 'Май', 002, 003, 007, 2, 30000),
       (10023, 'Май', 002, 004, 003, 1, 32000),
       (10024, 'Май', 004, 003, 005, 1, 47000),
       (10025, 'Май', 004, 006, 003, 4, 60000),
       (10026, 'Май', 005, 001, 005, 3, 80000),
       (10027, 'Июнь', 003, 002, 006, 2, 32000);
```

---

3. Используя оператор SELECT создать запрос для вывода всех строк каждой таблицы. Проверить правильность ввода. При
   необходимости произвести коррекцию значений операторами INSERT, UPDATE, DELETE.

```sql
select *
from "ПОКУПАТЕЛЬ";
```

| ИДЕНТИФИКАТОР | ФАМИЛИЯ | РАЙОН ПРОЖИВАНИЯ | СКИДКА, % |
| :--- | :--- | :--- | :--- |
| 1 | Cидоров | Нижегородский | 10 |
| 2 | Потапов | Советский | 20 |
| 3 | Попов | Ленинский | 10 |
| 4 | Романова | Нижегородский | 10 |
| 5 | Миронов | Автозаводский | 15 |
| 6 | Попов | Советский | 0 |

```sql
select *
from "МАГАЗИН";
```

| ИДЕНТИФИКАТОР | НАЗВАНИЕ | РАЙОН РАЗМЕЩЕНИЯ | КОММИСИОННЫЕ, % |
| :--- | :--- | :--- | :--- |
| 1 | Знание | Автозаводский | 7 |
| 2 | Наука | Нижегородский | 8 |
| 3 | Книжный мир | Приокский | 6 |
| 4 | Книги | Сормовский | 9 |
| 5 | Книги | Советский | 7 |

```sql
select *
from "КНИГИ";
```

| ИДЕНТИФИКАТОР | НАЗВАНИЕ | СТОИМОСТЬ, РУБ. | СКЛАД | КОЛ-ВО |
| :--- | :--- | :--- | :--- | :--- |
| 1 | Windows для чайников | 15000 | Сормовский | 400 |
| 2 | Excel 5.0 | 23000 | Сормовский | 360 |
| 3 | Работа с Visual FoxPro | 32000 | Нижегородский | 300 |
| 4 | Программирование в среде Delphi | 20000 | Нижегородский | 100 |
| 5 | SQL | 47000 | Автозаводский | 89 |
| 6 | Word 6.0 для Windows | 16000 | Сормовский | 200 |
| 7 | Твой первый выход в Internet | 15000 | Советский | 140 |

```sql
select *
from "ПОКУПКА";
```

| НОМЕР ЗАКАЗА | ДАТА | ПРОДАВЕЦ | ПОКУПАТЕЛЬ | КНИГА | КОЛ-ВО | СУММА, РУБ |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 10011 | Январь | 1 | 6 | 3 | 2 | 64000 |
| 10012 | Январь | 1 | 6 | 2 | 2 | 46000 |
| 10013 | Январь | 5 | 5 | 4 | 4 | 80000 |
| 10014 | Февраль | 1 | 3 | 3 | 3 | 96000 |
| 10015 | Февраль | 4 | 6 | 2 | 1 | 23000 |
| 10016 | Март | 1 | 4 | 7 | 2 | 30000 |
| 10017 | Март | 5 | 6 | 6 | 3 | 48000 |
| 10018 | Апрель | 1 | 1 | 3 | 3 | 96000 |
| 10019 | Апрель | 3 | 3 | 7 | 2 | 30000 |
| 10020 | Апрель | 5 | 2 | 2 | 5 | 115000 |
| 10021 | Апрель | 5 | 2 | 1 | 3 | 45000 |
| 10022 | Май | 2 | 3 | 7 | 2 | 30000 |
| 10023 | Май | 2 | 4 | 3 | 1 | 32000 |
| 10024 | Май | 4 | 3 | 5 | 1 | 47000 |
| 10025 | Май | 4 | 6 | 3 | 4 | 60000 |
| 10026 | Май | 5 | 1 | 5 | 3 | 80000 |
| 10027 | Июнь | 3 | 2 | 6 | 2 | 32000 |

---

4. Создать запросы для вывода:

- всех различных названий и стоимостей книг

```sql
select distinct "НАЗВАНИЕ", "СТОИМОСТЬ, РУБ."
from "КНИГИ"
```

| НАЗВАНИЕ | СТОИМОСТЬ, РУБ. |
| :--- | :--- |
| Windows для чайников | 15000 |
| SQL | 47000 |
| Excel 5.0 | 23000 |
| Твой первый выход в Internet | 15000 |
| Работа с Visual FoxPro | 32000 |
| Программирование в среде Delphi | 20000 |
| Word 6.0 для Windows | 16000 |

- всех различных районов, в которых проживают покупатели

```sql
select distinct "РАЙОН ПРОЖИВАНИЯ"
from "ПОКУПАТЕЛЬ";
```

| РАЙОН ПРОЖИВАНИЯ |
| :--- |
| Ленинский |
| Нижегородский |
| Автозаводский |
| Советский |

- всех различных месяцев, когда производились покупки

```sql
select distinct "ДАТА"
from "ПОКУПКА"
```

| ДАТА |
| :--- |
| Апрель |
| Май |
| Июнь |
| Февраль |
| Март |
| Январь |

---

5. Создать запросы для получения информации о:

- о фамилиях и размере скидки всех покупателей, проживающих в Нижегородском районе

```sql
select "ФАМИЛИЯ", "СКИДКА, %"
from "ПОКУПАТЕЛЬ"
where "РАЙОН ПРОЖИВАНИЯ" = 'Нижегородский'
```

| ФАМИЛИЯ | СКИДКА, % |
| :--- | :--- |
| Cидоров | 10 |
| Романова | 10 |

- о названиях магазинов Сормовского или Советского районов

```sql
select distinct "НАЗВАНИЕ"
from "МАГАЗИН"
where "РАЙОН РАЗМЕЩЕНИЯ" = 'Советский'
   or "РАЙОН РАЗМЕЩЕНИЯ" = 'Сормовский'
```

| НАЗВАНИЕ |
| :--- |
| Книги |

- о названиях и стоимости книг, в которых встречается слово Windows, или стоящих более 20000 руб. Вывод результатов
  организовать по названию и убыванию цены книг

```sql
select "НАЗВАНИЕ", "СТОИМОСТЬ, РУБ."
from "КНИГИ"
where lower("НАЗВАНИЕ") like lower('%windows%')
   or "СТОИМОСТЬ, РУБ." > 20000
```

| НАЗВАНИЕ | СТОИМОСТЬ, РУБ. |
| :--- | :--- |
| Windows для чайников | 15000 |
| Excel 5.0 | 23000 |
| Работа с Visual FoxPro | 32000 |
| SQL | 47000 |
| Word 6.0 для Windows | 16000 |

---

6. Для каждой покупки вывести следующие данные:

- фамилию покупателя и название магазина, где производилась покупка

```sql
select distinct "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "МАГАЗИН"."НАЗВАНИЕ"
from "ПОКУПАТЕЛЬ",
     "МАГАЗИН",
     "ПОКУПКА"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."ПРОДАВЕЦ" = "МАГАЗИН"."ИДЕНТИФИКАТОР"
```

| ФАМИЛИЯ | НАЗВАНИЕ |
| :--- | :--- |
| Романова | Наука |
| Cидоров | Знание |
| Попов | Книжный мир |
| Попов | Знание |
| Cидоров | Книги |
| Попов | Наука |
| Потапов | Книжный мир |
| Романова | Знание |
| Попов | Книги |
| Потапов | Книги |
| Миронов | Книги |

- дату, фамилию покупателя, скидку, название и количество купленных книг

```sql
select "ПОКУПКА"."ДАТА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПАТЕЛЬ"."СКИДКА, %", "КНИГИ"."НАЗВАНИЕ", "ПОКУПКА"."КОЛ-ВО"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."КНИГА" = "КНИГИ"."ИДЕНТИФИКАТОР"
```

| ДАТА | ФАМИЛИЯ | СКИДКА, % | НАЗВАНИЕ | КОЛ-ВО |
| :--- | :--- | :--- | :--- | :--- |
| Май | Cидоров | 10 | SQL | 3 |
| Апрель | Cидоров | 10 | Работа с Visual FoxPro | 3 |
| Июнь | Потапов | 20 | Word 6.0 для Windows | 2 |
| Апрель | Потапов | 20 | Excel 5.0 | 5 |
| Апрель | Потапов | 20 | Windows для чайников | 3 |
| Апрель | Попов | 10 | Твой первый выход в Internet | 2 |
| Май | Попов | 10 | Твой первый выход в Internet | 2 |
| Май | Попов | 10 | SQL | 1 |
| Февраль | Попов | 10 | Работа с Visual FoxPro | 3 |
| Март | Романова | 10 | Твой первый выход в Internet | 2 |
| Май | Романова | 10 | Работа с Visual FoxPro | 1 |
| Январь | Миронов | 15 | Программирование в среде Delphi | 4 |
| Март | Попов | 0 | Word 6.0 для Windows | 3 |
| Январь | Попов | 0 | Работа с Visual FoxPro | 2 |
| Май | Попов | 0 | Работа с Visual FoxPro | 4 |
| Январь | Попов | 0 | Excel 5.0 | 2 |
| Февраль | Попов | 0 | Excel 5.0 | 1 |

---

7. Определить:

- номер заказа, фамилию покупателя и дату для покупок в которых было продано книг на сумму не меньшую чем 60000 руб

```sql
select "ПОКУПКА"."НОМЕР ЗАКАЗА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПКА"."ДАТА"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."КНИГА" = "КНИГИ"."ИДЕНТИФИКАТОР"
group by "ПОКУПКА"."НОМЕР ЗАКАЗА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПКА"."ДАТА"
having SUM("ПОКУПКА"."СУММА, РУБ") >= 60000
```  

| НОМЕР ЗАКАЗА | ФАМИЛИЯ | ДАТА |
| :--- | :--- | :--- |
| 10025 | Попов | Май |
| 10018 | Cидоров | Апрель |
| 10011 | Попов | Январь |
| 10026 | Cидоров | Май |
| 10013 | Миронов | Январь |
| 10020 | Потапов | Апрель |
| 10014 | Попов | Февраль |

- покупки, сделанные покупателем в своем районе не ранее марта месяца. Вывести фамилию покупателя, район, дату

```sql
select "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ", "ПОКУПКА"."ДАТА"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ",
     "МАГАЗИН"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."КНИГА" = "КНИГИ"."ИДЕНТИФИКАТОР"
  and "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ" = "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ"
  and ("ПОКУПКА"."ДАТА" LIKE 'Январь'
    or "ПОКУПКА"."ДАТА" LIKE 'Февраль')
```

| ФАМИЛИЯ | РАЙОН ПРОЖИВАНИЯ | ДАТА |
| :--- | :--- | :--- |
| Миронов | Автозаводский | Январь |
| Попов | Советский | Февраль |
| Попов | Советский | Январь |
| Попов | Советский | Январь |

Произвести сортировку

- магазины, расположенные в любом районе, кроме Автозаводского, где покупали книги те, у кого скидка от 10 до 15 %

```sql
select "МАГАЗИН".*
from "МАГАЗИН",
     "ПОКУПКА",
     "ПОКУПАТЕЛЬ"
where "РАЙОН РАЗМЕЩЕНИЯ" not like 'Автозаводский'
  and "ПОКУПАТЕЛЬ"."СКИДКА, %" between 10 and 15
  and "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."ПРОДАВЕЦ" = "МАГАЗИН"."ИДЕНТИФИКАТОР"
order by "МАГАЗИН"."ИДЕНТИФИКАТОР", "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ"
```

| ИДЕНТИФИКАТОР | НАЗВАНИЕ | РАЙОН РАЗМЕЩЕНИЯ | КОММИСИОННЫЕ, % |
| :--- | :--- | :--- | :--- |
| 2 | Наука | Нижегородский | 8 |
| 2 | Наука | Нижегородский | 8 |
| 3 | Книжный мир | Приокский | 6 |
| 4 | Книги | Сормовский | 9 |
| 5 | Книги | Советский | 7 |
| 5 | Книги | Советский | 7 |

- данные по покупке книг (название, район складирования, количество), приобретенных в районе складирования и
  содержащихся в запасе более 10 штук. Включить данные о стоимости и отсортировать по возрастанию

```sql
select "КНИГИ"."НАЗВАНИЕ", "КНИГИ"."СКЛАД", "КНИГИ"."КОЛ-ВО", "КНИГИ"."СТОИМОСТЬ, РУБ."
from "КНИГИ",
     "МАГАЗИН"
where "КНИГИ"."СКЛАД" = "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ"
  and "КНИГИ"."КОЛ-ВО" > 10
order by "СТОИМОСТЬ, РУБ." desc
```

| НАЗВАНИЕ | СКЛАД | КОЛ-ВО | СТОИМОСТЬ, РУБ. |
| :--- | :--- | :--- | :--- |
| SQL | Автозаводский | 89 | 47000 |
| Работа с Visual FoxPro | Нижегородский | 300 | 32000 |
| Excel 5.0 | Сормовский | 360 | 23000 |
| Программирование в среде Delphi | Нижегородский | 100 | 20000 |
| Word 6.0 для Windows | Сормовский | 200 | 16000 |
| Windows для чайников | Сормовский | 400 | 15000 |
| Твой первый выход в Internet | Советский | 140 | 15000 |

---

8. Создать запрос для модификации всех значений столбца с суммарной величиной покупки, чтобы он содержал истинную сумму,
   оплачиваемую покупателем (с учетом скидки). Вывести новые значения

```sql
update "ПОКУПКА"
set "СУММА, РУБ" = "СУММА, РУБ" - "СУММА, РУБ" / 100 * (select "СКИДКА, %"
                                                        from "ПОКУПАТЕЛЬ"
                                                        where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР");
select *
from "ПОКУПКА";
```

| НОМЕР ЗАКАЗА | ДАТА | ПРОДАВЕЦ | ПОКУПАТЕЛЬ | КНИГА | КОЛ-ВО | СУММА, РУБ |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 10011 | Январь | 1 | 6 | 3 | 2 | 64000 |
| 10012 | Январь | 1 | 6 | 2 | 2 | 46000 |
| 10013 | Январь | 5 | 5 | 4 | 4 | 68000 |
| 10014 | Февраль | 1 | 3 | 3 | 3 | 86400 |
| 10015 | Февраль | 4 | 6 | 2 | 1 | 23000 |
| 10016 | Март | 1 | 4 | 7 | 2 | 27000 |
| 10017 | Март | 5 | 6 | 6 | 3 | 48000 |
| 10018 | Апрель | 1 | 1 | 3 | 3 | 86400 |
| 10019 | Апрель | 3 | 3 | 7 | 2 | 27000 |
| 10020 | Апрель | 5 | 2 | 2 | 5 | 92000 |
| 10021 | Апрель | 5 | 2 | 1 | 3 | 36000 |
| 10022 | Май | 2 | 3 | 7 | 2 | 27000 |
| 10023 | Май | 2 | 4 | 3 | 1 | 28800 |
| 10024 | Май | 4 | 3 | 5 | 1 | 42300 |
| 10025 | Май | 4 | 6 | 3 | 4 | 60000 |
| 10026 | Май | 5 | 1 | 5 | 3 | 72000 |
| 10027 | Июнь | 3 | 2 | 6 | 2 | 25600 |

---

9. Расширить таблицу с данными о покупке столбцом, содержащим величину комиссионных, получаемых магазином. Создать
   запрос для ввода конкретных значений во все строки таблицы покупок

```sql
alter table "ПОКУПКА"
    add column "КОМИСИОННЫЕ, РУБ" integer check ("СУММА, РУБ" >= 0) not null default 0;
update "ПОКУПКА"
set "КОМИСИОННЫЕ, РУБ" = "СУММА, РУБ" / 100 * (select "КОММИСИОННЫЕ, %"
                                               from "МАГАЗИН"
                                               where "ПОКУПКА"."ПРОДАВЕЦ" = "МАГАЗИН"."ИДЕНТИФИКАТОР");
select *
from "ПОКУПКА";
```

| НОМЕР ЗАКАЗА | ДАТА | ПРОДАВЕЦ | ПОКУПАТЕЛЬ | КНИГА | КОЛ-ВО | СУММА, РУБ | КОМИСИОННЫЕ, РУБ |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 10011 | Январь | 1 | 6 | 3 | 2 | 64000 | 4480 |
| 10012 | Январь | 1 | 6 | 2 | 2 | 46000 | 3220 |
| 10013 | Январь | 5 | 5 | 4 | 4 | 68000 | 4760 |
| 10014 | Февраль | 1 | 3 | 3 | 3 | 86400 | 6048 |
| 10015 | Февраль | 4 | 6 | 2 | 1 | 23000 | 2070 |
| 10016 | Март | 1 | 4 | 7 | 2 | 27000 | 1890 |
| 10017 | Март | 5 | 6 | 6 | 3 | 48000 | 3360 |
| 10018 | Апрель | 1 | 1 | 3 | 3 | 86400 | 6048 |
| 10019 | Апрель | 3 | 3 | 7 | 2 | 27000 | 1620 |
| 10020 | Апрель | 5 | 2 | 2 | 5 | 92000 | 6440 |
| 10021 | Апрель | 5 | 2 | 1 | 3 | 36000 | 2520 |
| 10022 | Май | 2 | 3 | 7 | 2 | 27000 | 2160 |
| 10023 | Май | 2 | 4 | 3 | 1 | 28800 | 2304 |
| 10024 | Май | 4 | 3 | 5 | 1 | 42300 | 3807 |
| 10025 | Май | 4 | 6 | 3 | 4 | 60000 | 5400 |
| 10026 | Май | 5 | 1 | 5 | 3 | 72000 | 5040 |
| 10027 | Июнь | 3 | 2 | 6 | 2 | 25600 | 1536 |

---

### Уровень 2

---

10. Используя операцию IN (NOT IN) реализовать следующие запросы:

- найти покупателей, которые не покупали книг в магазинах Нижегородского района в июне;

```sql
select "ПОКУПАТЕЛЬ"."ФАМИЛИЯ"
from "ПОКУПКА",
     "ПОКУПАТЕЛЬ"
where "ПОКУПКА"."ПРОДАВЕЦ" NOT IN (002)
  and "ПОКУПКА"."ДАТА" NOT IN ('Июнь')
group by "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР";
```

| ФАМИЛИЯ |
| :--- |
| Попов |
| Миронов |
| Романова |
| Попов |
| Потапов |
| Cидоров |

- найти покупателей, покупавших книги в мае на сумму, меньшую чем купил Потапов в том же месяце;

```sql
select distinct "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПКА"."СУММА, РУБ"
from "ПОКУПКА",
     "ПОКУПАТЕЛЬ"
where "ПОКУПАТЕЛЬ"."ФАМИЛИЯ" NOT IN ('Потапов')
  and "ПОКУПКА"."ДАТА" IN ('Май')
  and "ПОКУПКА"."СУММА, РУБ" > (select "ПОКУПКА"."СУММА, РУБ"
                                from "ПОКУПКА",
                                     "ПОКУПАТЕЛЬ"
                                where "ПОКУПАТЕЛЬ"."ФАМИЛИЯ" IN ('Потапов')
                                order by "ПОКУПКА"."СУММА, РУБ"
    limit 1)
order by "СУММА, РУБ" desc
```

| ФАМИЛИЯ | СУММА, РУБ |
| :--- | :--- |
| Cидоров | 80000 |
| Миронов | 80000 |
| Попов | 80000 |
| Романова | 80000 |
| Cидоров | 60000 |
| Миронов | 60000 |
| Попов | 60000 |
| Романова | 60000 |
| Cидоров | 47000 |
| Миронов | 47000 |
| Попов | 47000 |
| Романова | 47000 |
| Cидоров | 32000 |
| Миронов | 32000 |
| Попов | 32000 |
| Романова | 32000 |
| Cидоров | 30000 |
| Миронов | 30000 |
| Попов | 30000 |
| Романова | 30000 |

- реализовать запрос задания 7.а

```sql
select "ПОКУПКА"."НОМЕР ЗАКАЗА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПКА"."ДАТА"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" IN ("ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР")
  and "ПОКУПКА"."КНИГА" IN ("КНИГИ"."ИДЕНТИФИКАТОР")
group by "ПОКУПКА"."НОМЕР ЗАКАЗА", "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПКА"."ДАТА"
having SUM("ПОКУПКА"."СУММА, РУБ") >= 60000;
```

| НОМЕР ЗАКАЗА | ФАМИЛИЯ | ДАТА |
| :--- | :--- | :--- |
| 10025 | Попов | Май |
| 10018 | Cидоров | Апрель |
| 10011 | Попов | Январь |
| 10026 | Cидоров | Май |
| 10013 | Миронов | Январь |
| 10020 | Потапов | Апрель |
| 10014 | Попов | Февраль |

- реализовать запрос задания 7.с

```sql
select distinct "МАГАЗИН".*
from "МАГАЗИН",
     "ПОКУПКА",
     "ПОКУПАТЕЛЬ"
where "РАЙОН РАЗМЕЩЕНИЯ" NOT IN ('Автозаводский')
  and "ПОКУПАТЕЛЬ"."СКИДКА, %" IN (10, 11, 12, 13, 14, 15)
  and "ПОКУПКА"."ПОКУПАТЕЛЬ" IN ("ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР")
  and "ПОКУПКА"."ПРОДАВЕЦ" IN ("МАГАЗИН"."ИДЕНТИФИКАТОР")
order by "МАГАЗИН"."ИДЕНТИФИКАТОР", "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ";
```

| ИДЕНТИФИКАТОР | НАЗВАНИЕ | РАЙОН РАЗМЕЩЕНИЯ | КОММИСИОННЫЕ, % |
| :--- | :--- | :--- | :--- |
| 2 | Наука | Нижегородский | 8 |
| 3 | Книжный мир | Приокский | 6 |
| 4 | Книги | Сормовский | 9 |
| 5 | Книги | Советский | 7 |

---

11. Используя операции ALL-ANY реализовать следующие запросы:

- определить покупателя, имеющего минимальную скидку среди тех, кто покупал книги на сумму не менее 50000руб.

```sql
select "ФАМИЛИЯ", "СКИДКА, %"
from "ПОКУПАТЕЛЬ"
where "ПОКУПАТЕЛЬ"."СКИДКА, %" <= All (
    select "ПОКУПАТЕЛЬ"."СКИДКА, %"
    from ПОКУПАТЕЛЬ,
         ПОКУПКА
    where "СУММА, РУБ" >= 50000);
```

| ФАМИЛИЯ | СКИДКА, % |
| :--- | :--- |
| Попов | 0 |

- найти покупателя, покупавшего самое большое количество книг;

```sql
select "ФАМИЛИЯ", "КОЛ-ВО"
from "ПОКУПАТЕЛЬ",
     "ПОКУПКА" as P1
where P1."КОЛ-ВО" >= all (
    select P2."КОЛ-ВО"
    from ПОКУПКА as P2
    where P2."НОМЕР ЗАКАЗА" <> P1."НОМЕР ЗАКАЗА")
order by "КОЛ-ВО" limit 1
```

| ФАМИЛИЯ | КОЛ-ВО |
| :--- | :--- |
| Cидоров | 5 |

- запрос задания 7 (b)

```sql
select distinct "ПОКУПАТЕЛЬ"."ФАМИЛИЯ", "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ", "ПОКУПКА"."ДАТА"
from "ПОКУПКА",
     "КНИГИ",
     "ПОКУПАТЕЛЬ",
     "МАГАЗИН"
where "ПОКУПКА"."ПОКУПАТЕЛЬ" = "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР"
  and "ПОКУПКА"."КНИГА" = "КНИГИ"."ИДЕНТИФИКАТОР"
  and "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ" = "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ"
  and "ПОКУПКА"."ДАТА" = ANY (
    select "ПОКУПКА"."ДАТА"
    from "ПОКУПКА"
    where "ПОКУПКА"."ДАТА" in ('Январь', 'Февраль'));
```

| ФАМИЛИЯ | РАЙОН ПРОЖИВАНИЯ | ДАТА |
| :--- | :--- | :--- |
| Миронов | Автозаводский | Январь |
| Попов | Советский | Февраль |
| Попов | Советский | Январь |

- какой из покупателей не покупавший книг в магазинах своего района, делал покупки на минимальную сумму.

```sql
select ПОКУПАТЕЛЬ.ФАМИЛИЯ, min(ПОКУПКА."СУММА, РУБ")
from ПОКУПКА,
     ПОКУПАТЕЛЬ
where ПОКУПАТЕЛЬ.ФАМИЛИЯ in (
    select buyer.ФАМИЛИЯ
    from ПОКУПАТЕЛЬ buyer
    where buyer."РАЙОН ПРОЖИВАНИЯ" <> all (
        select shop."РАЙОН РАЗМЕЩЕНИЯ"
        from МАГАЗИН shop,
             ПОКУПКА purchase
        where buyer.ИДЕНТИФИКАТОР = purchase.ПОКУПАТЕЛЬ
        )
    )
group by ПОКУПАТЕЛЬ.ФАМИЛИЯ;
```
| ФАМИЛИЯ | min | 
| :--- | :--- |
| Попов | 23000 | 
---

12. Используя операцию UNION получить районы проживания покупателей и районы складирования книг.

```sql
select distinct "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ"
from "ПОКУПАТЕЛЬ"
UNION
select "КНИГИ"."СКЛАД"
FROM "КНИГИ";
```

| РАЙОН ПРОЖИВАНИЯ |
| :--- |
| Ленинский |
| Нижегородский |
| Автозаводский |
| Сормовский |
| Советский |

---

13. Используя операцию EXISTS (NOT EXISTS) реализовать нижеследующие запросы. В случае, если для текущего состояния БД
    запрос будет выдавать пустое множество строк, требуется указать какие добавления в БД необходимо провести.

- какой покупатель покупал все книги в магазине “Наука” или “Знание”;

```sql
select ФАМИЛИЯ
from ПОКУПАТЕЛЬ,
     ПОКУПКА
where not exists(
        select ФАМИЛИЯ
        from ПОКУПАТЕЛЬ,
             ПОКУПКА
        where ПОКУПКА.ПРОДАВЕЦ not In (001, 002));
```

| ФАМИЛИЯ |
| :--- |

- Возможные изменения:
 	* добавить нового покупателя или список таковых с последующим расширением таблицы покупок
 	* удалить некоторое кол-во значений из таблицы покупок
 	* уменьшить список книг в магазинах “Наука” или “Знание”

- найти покупателей, покупавших книги во всех магазинах своего района до декабря;

```sql
select ФАМИЛИЯ, ИДЕНТИФИКАТОР
from ПОКУПАТЕЛЬ buyer
where exists(
              select purchase.ПОКУПАТЕЛЬ
              from ПОКУПКА purchase,
                   МАГАЗИН store
              where buyer."РАЙОН ПРОЖИВАНИЯ" = store."РАЙОН РАЗМЕЩЕНИЯ"
                and purchase.ДАТА <> 'Декабрь');
```

| ФАМИЛИЯ | ИДЕНТИФИКАТОР |
| :--- | :--- |
| Cидоров | 1 |
| Потапов | 2 |
| Романова | 4 |
| Миронов | 5 |
| Попов | 6 |

- определить покупателей, покупавших все книги, не продающиеся я в магазине с максимальным значением комиссионных;

```sql
select ФАМИЛИЯ
from ПОКУПАТЕЛЬ buyer
where NOT EXISTS
(
        select КНИГИ.ИДЕНТИФИКАТОР
        from КНИГИ
        where ИДЕНТИФИКАТОР not in (
            select ПОКУПКА.КНИГА
            from ПОКУПКА
            where ПОКУПКА.ПРОДАВЕЦ = (
                select МАГАЗИН.ИДЕНТИФИКАТОР
                from МАГАЗИН
                where "КОММИСИОННЫЕ, %" = (
                    select max("КОММИСИОННЫЕ, %")
                    from МАГАЗИН
                )
            )
        )
    EXCEPT
        select КНИГА
        from ПОКУПКА
        where ПОКУПКА.ПОКУПАТЕЛЬ = buyer.ИДЕНТИФИКАТОР
);
```
| ФАМИЛИЯ |
| :--- |

- Возможные изменения:
 	* добавить новый магазин с наивысшим значением комиссионных
 	* добавить нового покуавтеля с расширением списка покупок
 	* увеличить кол-во значений в таблице покупок
 	* уменьшить список книг в магазине с максимальным значением комиссионных

- найти среди покупателей тех, кто не покупал в мае книг со ценой более 25000руб. в магазинах с максимальным размером
  комиссионных.

```sql
select ФАМИЛИЯ
from ПОКУПАТЕЛЬ buyer
where NOT EXISTS(
    select ПОКУПАТЕЛЬ
    from ПОКУПКА
    where buyer.ИДЕНТИФИКАТОР = ПОКУПКА.ПОКУПАТЕЛЬ
      and ПОКУПКА.ДАТА = 'Май'
      and ПОКУПКА."СУММА, РУБ" > 25000
      and ПОКУПКА.ПРОДАВЕЦ in (
        select МАГАЗИН.ИДЕНТИФИКАТОР
        from МАГАЗИН
        where "КОММИСИОННЫЕ, %" = (
            select max("КОММИСИОННЫЕ, %")
            from МАГАЗИН
        )
    )
);
```
| ФАМИЛИЯ |
| :--- |
| Cидоров |
| Миронов |
| Потапов |
| Романова |
---

14. Реализовать запросы с использованием агрегатных функций:

- получить среднюю стоимость покупок, сделанных в магазинах Нижегородского района

```sql
select sum("ПОКУПКА"."СУММА, РУБ") / count("ПОКУПКА"."СУММА, РУБ") as "СРЕДНЯЯ СТОИМОСТЬ"
from "ПОКУПКА"
```

| СРЕДНЯЯ СТОИМОСТЬ |
| :--- |
| 56117 |

- найти количество покупателей, покупавших книги в магазине “Наука”

```sql
select count("ПОКУПКА"."ПОКУПАТЕЛЬ")
from "ПОКУПКА",
     "МАГАЗИН"
where "ПОКУПКА"."ПРОДАВЕЦ" = "МАГАЗИН"."ИДЕНТИФИКАТОР"
  and "МАГАЗИН"."НАЗВАНИЕ" != 'Наука';
```

| count |
| :--- |
| 15 |

- найти покупателей имеющих скидку ниже средней

```sql
select *
from "ПОКУПАТЕЛЬ"
where (select avg("ПОКУПАТЕЛЬ"."СКИДКА, %") from "ПОКУПАТЕЛЬ") > "СКИДКА, %"
```  

| ИДЕНТИФИКАТОР | ФАМИЛИЯ | РАЙОН ПРОЖИВАНИЯ | СКИДКА, % |
| :--- | :--- | :--- | :--- |
| 1 | Cидоров | Нижегородский | 10 |
| 3 | Попов | Ленинский | 10 |
| 4 | Романова | Нижегородский | 10 |
| 6 | Попов | Советский | 0 |

- определить магазины, в которых покупало книги больше покупателей чем в магазине “Наука”

```sql
select "МАГАЗИН", sum("ПОКУПКА"."КОЛ-ВО")
from "ПОКУПКА",
     "МАГАЗИН"
where "МАГАЗИН"."ИДЕНТИФИКАТОР" = "ПОКУПКА"."ПРОДАВЕЦ"
group by "МАГАЗИН"
having sum("ПОКУПКА"."КОЛ-ВО") > (select sum("ПОКУПКА"."КОЛ-ВО")
                                  from "ПОКУПКА",
                                       "МАГАЗИН"
                                  where "МАГАЗИН"."ИДЕНТИФИКАТОР" = "ПРОДАВЕЦ"
                                    and "МАГАЗИН"."НАЗВАНИЕ" in ('Наука'))
order by sum("ПОКУПКА"."СУММА, РУБ") desc
```

| МАГАЗИН | sum |
| :--- | :--- |
| \(5,Книги,Советский,7\) | 18 |
| \(1,Знание,Автозаводский,7\) | 12 |
| \(4,Книги,Сормовский,9\) | 6 |
| \(3,"Книжный мир",Приокский,6\) | 4 |

---

15. Используя средства группировки реализовать следующие запросы:

- вывести данные по суммарной стоимости книг, купленных в каждом магазине

```sql
select "МАГАЗИН", sum("ПОКУПКА"."СУММА, РУБ")
from "ПОКУПКА",
     "МАГАЗИН"
where "МАГАЗИН"."ИДЕНТИФИКАТОР" = "ПОКУПКА"."ПРОДАВЕЦ"
group by "МАГАЗИН"
order by sum("ПОКУПКА"."СУММА, РУБ") desc
```

| МАГАЗИН | sum |
| :--- | :--- |
| \(5,Книги,Советский,7\) | 368000 |
| \(1,Знание,Автозаводский,7\) | 332000 |
| \(4,Книги,Сормовский,9\) | 130000 |
| \(2,Наука,Нижегородский,8\) | 62000 |
| \(3,"Книжный мир",Приокский,6\) | 62000 |

- вывести отчет о суммарной стоимости всех купленных книг по районам, где расположены магазины

```sql
select "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ", sum("ПОКУПКА"."СУММА, РУБ")
from "ПОКУПКА",
     "МАГАЗИН"
where "МАГАЗИН"."ИДЕНТИФИКАТОР" = "ПОКУПКА"."ПРОДАВЕЦ"
group by "МАГАЗИН"."РАЙОН РАЗМЕЩЕНИЯ"
order by sum("ПОКУПКА"."СУММА, РУБ") desc
```

| РАЙОН РАЗМЕЩЕНИЯ | sum |
| :--- | :--- |
| Советский | 368000 |
| Автозаводский | 332000 |
| Сормовский | 130000 |
| Нижегородский | 62000 |
| Приокский | 62000 |

- получить сводную информацию о сумме всех покупок, произведенных каждым покупателем

```sql
select "ПОКУПАТЕЛЬ", sum("ПОКУПКА"."СУММА, РУБ")
from "ПОКУПКА",
     "ПОКУПАТЕЛЬ"
where "ПОКУПАТЕЛЬ"."ИДЕНТИФИКАТОР" = "ПОКУПКА"."ПРОДАВЕЦ"
group by "ПОКУПАТЕЛЬ"
order by sum("ПОКУПКА"."СУММА, РУБ") desc
```

| ПОКУПАТЕЛЬ | sum |
| :--- | :--- |
| 6 | 241000 |
| 3 | 203000 |
| 2 | 192000 |
| 1 | 176000 |
| 5 | 80000 |
| 4 | 62000 |

- определить для каждого месяца количество книг, купленных покупателями не из Советского района

```sql
select "ПОКУПКА"."ДАТА", sum("ПОКУПКА"."КОЛ-ВО")
from "ПОКУПКА",
     "ПОКУПАТЕЛЬ"
where "ПОКУПАТЕЛЬ"."РАЙОН ПРОЖИВАНИЯ" not in ('Советский')
group by "ПОКУПКА"."ДАТА"
order by sum("ПОКУПКА"."СУММА, РУБ") desc
```

| ДАТА | sum |
| :--- | :--- |
| Апрель | 52 |
| Май | 44 |
| Январь | 32 |
| Февраль | 16 |
| Март | 20 |
| Июнь | 8 |
